<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Dashmin Form Builder Prototype</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <style>
        body {
            height: 100vh;
            margin: 0;
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
        }

        .tool {
            cursor: grab;
        }

        .tool:active {
            cursor: grabbing;
        }

        #toolbox,
        #form-canvas,
        #properties {
            padding: 1rem;
            overflow-y: auto;
        }

        #properties form>div {
            margin-bottom: 0.75rem;
        }

        .drop-zone {
            border: 2px dashed #ccc;
            border-radius: 4px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .drop-zone.drag-over {
            border-color: #007cba;
            background: #f9f9f9;
        }

        .drop-label {
            display: block;
            cursor: pointer;
        }

        .drop-label>* {
            display: block;
        }

        .drop-zone .drop-preview {
            max-width: 100%;
            height: auto;
            border-radius: var(--border-radius);
            margin-block-end: var(--space-sm);
        }
    </style>
</head>

<body>

    <!-- Left Pane: Toolbox -->
    <section id="toolbox">
        <h4>Fields</h4>

        <div class="tool">
            <div class="field">
                <label>Input</label>
                <input type="text" placeholder="Single line">
            </div>
        </div>

        <div class="tool">
            <div class="field">
                <label>Select</label>
                <select>
                    <option>Option 1</option>
                </select>
            </div>
        </div>

        <div class="tool">
            <div class="field">
                <label>Textarea</label>
                <textarea placeholder="Multiline text"></textarea>
            </div>
        </div>

        <div class="tool">
            <div class="field drop-zone" data-upload="/upload/endpoint/">
                <label class="drop-label">
                    <span>Drop file or click</span>
                </label>
                <input type="file" name="file" hidden>
                <img class="drop-preview" alt="" style="max-width:100%;display:none;">
            </div>
        </div>
    </section>

    <!-- Middle Pane: Canvas -->
    <section id="form-canvas">
        <h4>Form Canvas</h4>
    </section>

    <!-- Right Pane: Properties -->
    <section id="properties">
        <h4>Properties</h4>
        <form id="properties-form">
            <p>Click a field to edit</p>
        </form>
    </section>

    <!-- Templates for Properties -->
    <template id="tmpl-generic">
        <div class="prop-generic">
            <div>
                <label>Label</label>
                <input type="text" class="prop-label">
            </div>
            <div>
                <label>Placeholder</label>
                <input type="text" class="prop-placeholder">
            </div>
            <div>
                <label><input type="checkbox" class="prop-required"> Required</label>
            </div>
            <div>
                <label>Default value</label>
                <input type="text" class="prop-default">
            </div>
        </div>
    </template>

    <template id="tmpl-input">
        <div class="prop-input">
            <div>
                <label>Type</label>
                <select class="prop-input-type">
                    <option value="text">Text</option>
                    <option value="number">Number</option>
                    <option value="email">Email</option>
                    <option value="date">Date</option>
                    <option value="password">Password</option>
                    <option value="url">URL</option>
                    <option value="file">File</option>
                </select>
            </div>
            <div class="extra-range">
                <label>Min</label>
                <input type="number" class="prop-min">
                <label>Max</label>
                <input type="number" class="prop-max">
            </div>
        </div>
    </template>

    <template id="tmpl-select">
        <div class="prop-select">
            <div>
                <label>Options (comma separated)</label>
                <input type="text" class="prop-options">
            </div>
        </div>
    </template>

    <template id="tmpl-textarea">
        <div class="prop-textarea">
            <div>
                <label>Rows</label>
                <input type="number" class="prop-rows" min="1">
            </div>
            <div>
                <label>Maxlength</label>
                <input type="number" class="prop-maxlength" min="1">
            </div>
            <div>
                <label>Wrap</label>
                <select class="prop-wrap">
                    <option value="">Default</option>
                    <option value="soft">Soft</option>
                    <option value="hard">Hard</option>
                    <option value="off">Off</option>
                </select>
            </div>
        </div>
    </template>


    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script>
        const toolbox = document.getElementById('toolbox');
        const canvas = document.getElementById('form-canvas');
        const propertiesForm = document.getElementById('properties-form');
        let selectedField = null;

        // Make toolbox a non-sortable source (cloning)
        Sortable.create(toolbox, {
            group: { name: 'fields', pull: 'clone', put: false },
            sort: false,
            animation: 150
        });

        // Make canvas sortable and accept clones
        Sortable.create(canvas, {
            group: { name: 'fields', pull: false, put: true },
            animation: 150,
            onAdd(evt) {
                // evt.item is the cloned .tool wrapper
                const field = evt.item.querySelector('.field');
                if (field) {
                    evt.item.replaceWith(field); // keep only the .field itself
                    attachProperties(field);
                    selectedField = field;       // set current selection
                    showProperties(field);       // <<< open properties pane right away
                }
            }
        });


        function attachProperties(field) {
            field.addEventListener('click', () => {
                selectedField = field;
                showProperties(field);
            });
        }

        function showProperties(field) {
            propertiesForm.innerHTML = '';
            const input = field.querySelector('input, select, textarea');
            const label = field.querySelector('label');
            if (!input) return;

            // Generic controls
            const base = document.getElementById('tmpl-generic').content.cloneNode(true);
            propertiesForm.appendChild(base);

            // Bind generic
            propertiesForm.querySelector('.prop-label').value = label?.innerText || '';
            propertiesForm.querySelector('.prop-placeholder').value = input.placeholder || '';
            propertiesForm.querySelector('.prop-required').checked = input.required || false;
            propertiesForm.querySelector('.prop-default').value = input.value || '';

            propertiesForm.querySelector('.prop-label').oninput = e => { if (label) label.innerText = e.target.value; };
            propertiesForm.querySelector('.prop-placeholder').oninput = e => { input.placeholder = e.target.value; };
            propertiesForm.querySelector('.prop-required').onchange = e => { input.required = e.target.checked; };
            propertiesForm.querySelector('.prop-default').oninput = e => { input.value = e.target.value; };

            // Input-specific
            if (input.tagName === 'INPUT') {
                const inputProps = document.getElementById('tmpl-input').content.cloneNode(true);
                propertiesForm.appendChild(inputProps);

                const typeSelect = propertiesForm.querySelector('.prop-input-type');
                typeSelect.value = input.type || 'text';
                typeSelect.onchange = e => {
                    input.type = e.target.value;
                    toggleRangeControls();
                };

                const minEl = propertiesForm.querySelector('.prop-min');
                const maxEl = propertiesForm.querySelector('.prop-max');
                minEl.value = input.min || '';
                maxEl.value = input.max || '';
                minEl.oninput = e => { input.min = e.target.value; };
                maxEl.oninput = e => { input.max = e.target.value; };

                function toggleRangeControls() {
                    propertiesForm.querySelector('.extra-range').style.display =
                        (input.type === 'number' || input.type === 'date') ? 'block' : 'none';
                }

                toggleRangeControls();
            }

            // Select-specific
            else if (input.tagName === 'SELECT') {
                const selectProps = document.getElementById('tmpl-select').content.cloneNode(true);
                propertiesForm.appendChild(selectProps);

                const optionsEl = propertiesForm.querySelector('.prop-options');
                optionsEl.value = Array.from(input.options).map(o => o.text).join(', ');
                optionsEl.oninput = e => {
                    const values = e.target.value.split(',').map(s => s.trim()).filter(Boolean);
                    input.innerHTML = '';
                    values.forEach(v => {
                        const opt = document.createElement('option');
                        opt.text = v;
                        opt.value = v;
                        input.add(opt);
                    });
                };
            }

            else if (input.tagName === 'TEXTAREA') {
                const taProps = document.getElementById('tmpl-textarea').content.cloneNode(true);
                propertiesForm.appendChild(taProps);

                const rowsEl = propertiesForm.querySelector('.prop-rows');
                const maxEl = propertiesForm.querySelector('.prop-maxlength');
                const wrapEl = propertiesForm.querySelector('.prop-wrap');

                rowsEl.value = input.rows || '';
                maxEl.value = input.maxLength > 0 ? input.maxLength : '';
                wrapEl.value = input.wrap || '';

                rowsEl.oninput = e => { input.rows = e.target.value; };
                maxEl.oninput = e => { input.maxLength = e.target.value; };
                wrapEl.onchange = e => { input.wrap = e.target.value; };
            }

        }
    </script>
</body>

</html>