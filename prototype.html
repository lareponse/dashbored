<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Dashmin Form Builder Prototype</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <style>
        #builder {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 1rem;
        }

        #toolbox,
        #form-fields,
        #locked-fields {
            min-height: 150px;
            padding: 1rem;
            border: 2px dashed var(--muted-color);
            border-radius: 0.5rem;
        }

        #toolbox .field,
        #form-fields .field,
        #locked-fields .field {
            padding: 0.5rem;
            margin: 0.25rem 0;
            border: 1px solid var(--muted-border-color);
            border-radius: 0.25rem;
            background: var(--card-background-color);
            cursor: grab;
        }

        #locked-fields .field {
            background: var(--muted-border-color);
            cursor: not-allowed;
            opacity: 0.8;
        }
    </style>
</head>

<body>
    <main class="container">
        <h1>Form Builder (Prototype)</h1>
        <div id="builder">
            <!-- Toolbox -->
            <section>
                <h4>Toolbox</h4>
                <div id="toolbox">
                    <div class="field" data-type="text">Text Input</div>
                    <div class="field" data-type="number">Number Input</div>
                    <div class="field" data-type="boolean">Boolean Select</div>
                    <div class="field" data-type="email">Email Input</div>
                    <div class="field" data-type="date">Date Picker</div>
                    <div class="field" data-type="textarea">Textarea</div>
                    <div class="field" data-type="select">Dropdown</div>
                </div>
            </section>

            <!-- Form Area -->
            <section>
                <h4>Custom Fields</h4>
                <form id="form">
                    <div id="form-fields"></div>
                    <button type="submit">Submit</button>
                </form>
            </section>
        </div>

        <!-- Locked fields shown separately -->
        <section>
            <h4>Common Fields (always included)</h4>
            <div id="locked-fields"></div>
        </section>

        <button id="export">Export Schema</button>
    </main>

    <!-- SortableJS -->
    <script type="module">
        import Sortable from "https://cdn.jsdelivr.net/npm/sortablejs@1.15.3/modular/sortable.esm.js";

        const toolbox = document.getElementById("toolbox");
        const formFields = document.getElementById("form-fields");
        const lockedFields = document.getElementById("locked-fields");

        // Toolbox → clone fields
        Sortable.create(toolbox, {
            group: { name: "fields", pull: "clone", put: false },
            sort: false,
            animation: 150
        });

        // Form area → sortable & accepts clones
        Sortable.create(formFields, {
            group: { name: "fields", pull: true, put: true },
            animation: 150,
            onAdd: (evt) => {
                const type = evt.item.dataset.type;
                const fieldNode = renderField(type);
                evt.item.replaceWith(fieldNode);
            }
        });

        function renderField(type, locked = false) {
            const tpl = document.getElementById(`tpl-${type}`);
            if (!tpl) return document.createTextNode("Unknown field");

            const node = tpl.content.cloneNode(true).firstElementChild;

            // Assign unique id/name
            const id = "f" + Math.random().toString(36).substr(2, 5);
            const input = node.querySelector("input, select, textarea");
            const label = node.querySelector("label");

            if (input) {
                input.id = id;
                input.name = id;
            }
            if (label) {
                label.setAttribute("for", id);
            }

            if (locked) {
                node.classList.add("locked");
                node.dataset.locked = "true";
            }

            return node;
        }

        // Inject common fields (locked, non-sortable)
        const commonFields = [
            { type: "text", label: "ID (auto)" },
            { type: "date", label: "Created At" },
            { type: "date", label: "Updated At" },
            { type: "date", label: "Enabled At" },
            { type: "date", label: "Revoked At" }
        ];

        commonFields.forEach(f => {
            const node = renderField(f.type, true);
            node.querySelector("label").textContent = f.label;
            lockedFields.appendChild(node);
        });

        // Inject "Label" into form builder by default
        const labelField = renderField("text");
        labelField.querySelector("label").textContent = "Label";
        formFields.appendChild(labelField);

        // Export schema
        document.getElementById("export").addEventListener("click", () => {
            const custom = [...formFields.children].map((el, idx) => ({
                name: el.querySelector("[name]").name,
                type: el.dataset.type,
                order: idx,
                locked: false
            }));

            const locked = [...lockedFields.children].map((el, idx) => ({
                name: el.querySelector("[name]").name,
                type: el.dataset.type,
                order: idx,
                locked: true
            }));

            const schema = [...locked, ...custom];
            console.log("Schema:", schema);
            alert("Schema logged to console.");
        });
    </script>

    <!-- Templates -->
    <template id="tpl-text">
        <div class="field" data-type="text">
            <label>Text</label>
            <input type="text" required>
        </div>
    </template>

    <template id="tpl-number">
        <div class="field" data-type="number">
            <label>Number</label>
            <input type="number" required>
        </div>
    </template>

    <template id="tpl-boolean">
        <div class="field" data-type="boolean">
            <label>Boolean</label>
            <select>
                <option value="1">Yes</option>
                <option value="0">No</option>
            </select>
        </div>
    </template>

    <template id="tpl-email">
        <div class="field" data-type="email">
            <label>Email</label>
            <input type="email" required>
        </div>
    </template>

    <template id="tpl-date">
        <div class="field" data-type="date">
            <label>Date</label>
            <input type="date" required>
        </div>
    </template>

    <template id="tpl-textarea">
        <div class="field" data-type="textarea">
            <label>Textarea</label>
            <textarea rows="3"></textarea>
        </div>
    </template>

    <template id="tpl-select">
        <div class="field" data-type="select">
            <label>Options</label>
            <select>
                <option value="">-- Choose --</option>
                <option value="a">Option A</option>
                <option value="b">Option B</option>
            </select>
        </div>
    </template>
</body>

</html>