<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Dashmin Form Builder Prototype</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <style>
        body {
            height: 100vh;
            margin: 0;
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
        }

        .tool {
            cursor: grab;
        }

        .tool:active {
            cursor: grabbing;
        }

        #toolbox,
        #form-canvas,
        #properties {
            padding: 1rem;
            overflow-y: auto;
        }

        #properties form>div {
            margin-bottom: 0.75rem;
        }

        .drop-zone {
            border: 2px dashed #ccc;
            border-radius: 4px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .drop-zone.drag-over {
            border-color: #007cba;
            background: #f9f9f9;
        }

        .drop-label {
            display: block;
            cursor: pointer;
        }

        .drop-label>* {
            display: block;
        }

        .drop-zone .drop-preview {
            max-width: 100%;
            height: auto;
            border-radius: var(--border-radius);
            margin-block-end: var(--space-sm);
        }
    </style>
</head>

<body>

    <!-- Left Pane: Toolbox -->
    <section id="toolbox">
        <h4>Fields</h4>

        <div class="tool">
            <div class="field">
                <label>Input</label>
                <input type="text" placeholder="Single line">
            </div>
        </div>

        <div class="tool">
            <div class="field">
                <label>Select</label>
                <select>
                    <option>Option 1</option>
                </select>
            </div>
        </div>

        <div class="tool">
            <div class="field">
                <label>Textarea</label>
                <textarea placeholder="Multiline text"></textarea>
            </div>
        </div>

        <div class="tool">
            <div class="field drop-zone" data-upload="/upload/endpoint/">
                <label class="drop-label">
                    <span>Drop file or click</span>
                </label>
                <input type="file" name="file" hidden>
                <img class="drop-preview" alt="" style="max-width:100%;display:none;">
            </div>
        </div>
    </section>

    <!-- Middle Pane: Canvas -->
    <section id="form-canvas">
        <h4>Form Canvas</h4>
    </section>

    <!-- Right Pane: Properties -->
    <section id="properties">
        <h4>Properties</h4>
        <form id="properties-form">
            <p>Click a field to edit</p>
        </form>
    </section>

    <!-- Templates for Properties -->
    <template id="tmpl-generic">
        <div class="prop-generic">
            <div>
                <label>Label</label>
                <input type="text" class="prop-label">
            </div>

            <div>
                <label>Required</label>
                <select class="prop-required">
                    <option value="false" selected>Not required</option>
                    <option value="true">Required</option>
                </select>
            </div>
        </div>
    </template>

    <template id="tmpl-input">
        <div class="prop-input">
            <div>
                <label>Type</label>
                <select class="prop-input-type">
                    <option value="text">Text</option>
                    <option value="number">Number</option>
                    <option value="email">Email</option>
                    <option value="date">Date</option>
                    <option value="password">Password</option>
                    <option value="url">URL</option>
                    <option value="file">File</option>
                </select>
            </div>
            <div>
                <label>Default value</label>
                <input type="text" class="prop-default">
            </div>
            <div>
                <label>Placeholder</label>
                <input type="text" class="prop-placeholder">
            </div>
            <div class="extra-range">
                <label>Min</label>
                <input type="number" class="prop-min">
                <label>Max</label>
                <input type="number" class="prop-max">
            </div>
        </div>
    </template>

    <template id="tmpl-text-text">
        <div class="prop-text-text">
            <div>
                <label>Minlength</label>
                <input type="number" class="prop-minlength" min="0">
            </div>
            <div>
                <label>Maxlength</label>
                <input type="number" class="prop-maxlength" min="1">
            </div>

            <div>
                <label>Size (chars)</label>
                <input type="number" class="prop-size" min="1">
            </div>
            <div>
                <label>Autocomplete</label>
                <select class="prop-autocomplete">
                    <option value="off">Off</option>
                    <option value="on">On</option>
                </select>
            </div>
            <div>
                <label>Pattern (regex)</label>
                <input type="text" class="prop-pattern">
            </div>
        </div>
    </template>

    <template id="tmpl-select">
        <div class="prop-select">
            <div>
                <label>Options (comma separated)</label>
                <input type="text" class="prop-options">
            </div>
            <div>
                <label>Required</label>
                <select class="prop-required">
                    <option value="false" selected>Not required</option>
                    <option value="true">Required</option>
                </select>
            </div>
            <div>
                <label>Multiple</label>
                <select class="prop-multiple">
                    <option value="false" selected>Single choice</option>
                    <option value="true">Multiple choices</option>
                </select>
            </div>
            <div>
                <label>Size (rows)</label>
                <input type="number" class="prop-size" min="1">
            </div>
            <div>
                <label>Default selected option</label>
                <select class="prop-default-option"></select>
            </div>
        </div>
    </template>


    <template id="tmpl-textarea">
        <div class="prop-textarea">
            <div>
                <label>Rows</label>
                <input type="number" class="prop-rows" min="1">
            </div>
            <div>
                <label>Maxlength</label>
                <input type="number" class="prop-maxlength" min="1">
            </div>
            <div>
                <label>Placeholder</label>
                <input type="text" class="prop-placeholder">
            </div>
            <div>
                <label>Default value</label>
                <input type="text" class="prop-default">
            </div>
            <div>
                <label>Wrap</label>
                <select class="prop-wrap">
                    <option value="">Default</option>
                    <option value="soft">Soft</option>
                    <option value="hard">Hard</option>
                    <option value="off">Off</option>
                </select>
            </div>
        </div>
    </template>


    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script>
        const toolbox = document.getElementById('toolbox');
        const canvas = document.getElementById('form-canvas');
        const propertiesForm = document.getElementById('properties-form');
        let selectedField = null;

        // ---- persistence ----
        function saveCanvas() {
            localStorage.setItem('dashmin-canvas', canvas.innerHTML);
        }

        function restoreCanvas() {
            const saved = localStorage.getItem('dashmin-canvas');
            if (saved) {
                canvas.innerHTML = saved;
                canvas.querySelectorAll('.field').forEach(f => attachProperties(f));
            }
        }

        // Make toolbox a non-sortable source (cloning)
        Sortable.create(toolbox, {
            group: { name: 'fields', pull: 'clone', put: false },
            sort: false,
            animation: 150
        });

        // Make canvas sortable and accept clones
        Sortable.create(canvas, {
            group: { name: 'fields', pull: false, put: true },
            animation: 150,
            onAdd(evt) {
                const field = evt.item.querySelector('.field');
                if (field) {
                    evt.item.replaceWith(field);
                    attachProperties(field);
                    selectedField = field;
                    showProperties(field);
                    saveCanvas();
                }
            },
            onSort(evt) {
                saveCanvas();
            }
        });

        function attachProperties(field) {
            field.addEventListener('click', () => {
                selectedField = field;
                showProperties(field);
            });
        }

        function showProperties(field) {
            propertiesForm.innerHTML = '';
            const input = field.querySelector('input, select, textarea');
            const label = field.querySelector('label');
            if (!input) return;

            const base = document.getElementById('tmpl-generic').content.cloneNode(true);
            propertiesForm.appendChild(base);

            propertiesForm.querySelector('.prop-label').value = label?.innerText || '';
            propertiesForm.querySelector('.prop-label').oninput = e => { if (label) label.innerText = e.target.value; saveCanvas(); };

            const requiredEl = propertiesForm.querySelector('.prop-required');
            requiredEl.value = input.required ? 'true' : 'false';
            requiredEl.onchange = e => {
                input.required = (e.target.value === 'true');
                saveCanvas();
            };

            if (input.tagName === 'INPUT') {
                const inputProps = document.getElementById('tmpl-input').content.cloneNode(true);
                propertiesForm.appendChild(inputProps);

                // type selector
                const typeSelect = propertiesForm.querySelector('.prop-input-type');
                typeSelect.value = input.type || 'text';
                typeSelect.onchange = e => {
                    input.type = e.target.value;
                    toggleRangeControls();
                    saveCanvas();
                };

                // default + placeholder
                const defaultEl = propertiesForm.querySelector('.prop-default');
                defaultEl.value = input.dataset.default || '';
                defaultEl.oninput = e => {
                    input.dataset.default = e.target.value;
                    saveCanvas();
                };

                const placeholderEl = propertiesForm.querySelector('.prop-placeholder');
                placeholderEl.value = input.placeholder || '';
                placeholderEl.oninput = e => { input.placeholder = e.target.value; saveCanvas(); };

                // range controls
                const minEl = propertiesForm.querySelector('.prop-min');
                const maxEl = propertiesForm.querySelector('.prop-max');
                minEl.value = input.min || '';
                maxEl.value = input.max || '';
                minEl.oninput = e => { input.min = e.target.value; saveCanvas(); };
                maxEl.oninput = e => { input.max = e.target.value; saveCanvas(); };

                function toggleRangeControls() {
                    propertiesForm.querySelector('.extra-range').style.display =
                        (input.type === 'number' || input.type === 'date') ? 'block' : 'none';
                }

                toggleRangeControls();

                if (input.type === 'text') {
                    const textProps = document.getElementById('tmpl-text-text').content.cloneNode(true);
                    propertiesForm.appendChild(textProps);

                    const minEl = propertiesForm.querySelector('.prop-minlength');
                    const maxEl = propertiesForm.querySelector('.prop-maxlength');
                    const patEl = propertiesForm.querySelector('.prop-pattern');
                    const sizeEl = propertiesForm.querySelector('.prop-size');
                    const acEl = propertiesForm.querySelector('.prop-autocomplete');

                    minEl.value = input.minLength > 0 ? input.minLength : '';
                    maxEl.value = input.maxLength > 0 ? input.maxLength : '';
                    patEl.value = input.pattern || '';
                    sizeEl.value = input.size || '';
                    acEl.value = input.autocomplete || '';

                    minEl.oninput = e => { input.minLength = e.target.value; saveCanvas(); };
                    maxEl.oninput = e => { input.maxLength = e.target.value; saveCanvas(); };
                    patEl.oninput = e => { input.pattern = e.target.value; saveCanvas(); };
                    sizeEl.oninput = e => { input.size = e.target.value; saveCanvas(); };
                    acEl.onchange = e => { input.autocomplete = e.target.value; saveCanvas(); };
                }
            }

            else if (input.tagName === 'SELECT') {
                const selectProps = document.getElementById('tmpl-select').content.cloneNode(true);
                propertiesForm.appendChild(selectProps);

                const optionsEl = propertiesForm.querySelector('.prop-options');
                optionsEl.value = Array.from(input.options).map(o => o.text).join(', ');
                optionsEl.oninput = e => {
                    const values = e.target.value.split(',').map(s => s.trim()).filter(Boolean);
                    input.innerHTML = '';
                    values.forEach(v => {
                        const opt = document.createElement('option');
                        opt.text = v;
                        opt.value = v;
                        input.add(opt);
                    });
                    refreshDefaultOptions();
                    saveCanvas();
                };

                const multipleEl = propertiesForm.querySelector('.prop-multiple');
                multipleEl.value = input.multiple ? 'true' : 'false';
                multipleEl.onchange = e => { input.multiple = (e.target.value === 'true'); saveCanvas(); };

                const sizeEl = propertiesForm.querySelector('.prop-size');
                sizeEl.value = input.size || 1;
                sizeEl.oninput = e => { input.size = e.target.value; saveCanvas(); };

                const defaultEl = propertiesForm.querySelector('.prop-default-option');
                function refreshDefaultOptions() {
                    defaultEl.innerHTML = '';
                    Array.from(input.options).forEach((opt, idx) => {
                        const o = document.createElement('option');
                        o.value = idx;
                        o.text = opt.text;
                        if (opt.selected) o.selected = true;
                        defaultEl.add(o);
                    });
                }
                refreshDefaultOptions();

                defaultEl.onchange = e => {
                    const idx = parseInt(e.target.value, 10);
                    Array.from(input.options).forEach((opt, i) => opt.selected = (i === idx));
                    saveCanvas();
                };
            }

            else if (input.tagName === 'TEXTAREA') {
                const taProps = document.getElementById('tmpl-textarea').content.cloneNode(true);
                propertiesForm.appendChild(taProps);

                const rowsEl = propertiesForm.querySelector('.prop-rows');
                const maxEl = propertiesForm.querySelector('.prop-maxlength');
                const wrapEl = propertiesForm.querySelector('.prop-wrap');
                const placeholderEl = propertiesForm.querySelector('.prop-placeholder');
                const defaultEl = propertiesForm.querySelector('.prop-default');

                rowsEl.value = input.rows || '';
                maxEl.value = input.maxLength > 0 ? input.maxLength : '';
                wrapEl.value = input.wrap || '';
                placeholderEl.value = input.placeholder || '';
                defaultEl.value = input.dataset.default || '';

                rowsEl.oninput = e => { input.rows = e.target.value; saveCanvas(); };
                maxEl.oninput = e => { input.maxLength = e.target.value; saveCanvas(); };
                wrapEl.onchange = e => { input.wrap = e.target.value; saveCanvas(); };
                placeholderEl.oninput = e => { input.placeholder = e.target.value; saveCanvas(); };
                defaultEl.oninput = e => { input.dataset.default = e.target.value; saveCanvas(); };
            }
        }

        window.addEventListener('DOMContentLoaded', restoreCanvas);
    </script>
</body>

</html>