<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Dashmin Form Builder Prototype</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <style>
        body {
            height: 100vh;
            margin: 0;
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
        }

        .tool {
            cursor: grab;
        }

        .tool:active {
            cursor: grabbing;
        }

        .field label:has(+ [required])::after {
            content: " *";
            color: red;
            margin-left: 0.25rem;
            font-weight: bold;
        }

        #toolbox,
        #form-canvas,
        #properties {
            padding: 1rem;
            overflow-y: auto;
        }

        #properties form>div {
            margin-bottom: 0.75rem;
        }

        .drop-zone {
            border: 2px dashed #ccc;
            border-radius: 4px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .drop-zone.drag-over {
            border-color: #007cba;
            background: #f9f9f9;
        }

        .drop-label {
            display: block;
            cursor: pointer;
        }

        .drop-label>* {
            display: block;
        }

        .drop-zone .drop-preview {
            max-width: 100%;
            height: auto;
            border-radius: var(--border-radius);
            margin-block-end: var(--space-sm);
        }
    </style>
</head>

<body>

    <!-- Left Pane: Toolbox -->
    <section id="toolbox">
        <h4>Fields</h4>

        <div class="tool">
            <div class="field">
                <label>Input</label>
                <input type="text" placeholder="Single line">
            </div>
        </div>

        <div class="tool">
            <div class="field">
                <label>Select</label>
                <select>
                    <option>Option 1</option>
                </select>
            </div>
        </div>

        <div class="tool">
            <div class="field">
                <label>Textarea</label>
                <textarea placeholder="Multiline text"></textarea>
            </div>
        </div>

        <div class="tool">
            <div class="field drop-zone" data-upload="/upload/endpoint/">
                <label class="drop-label">
                    <span>Drop file or click</span>
                </label>
                <input type="file" name="file" hidden>
                <img class="drop-preview" alt="" style="max-width:100%;display:none;">
            </div>
        </div>


        <div style="padding:1rem;">
            <button id="generate-sql" class="contrast">Generate SQL</button>
            <pre id="sql-output" style="margin-top:1rem;white-space:pre-wrap;"></pre>
        </div>
    </section>

    <!-- Middle Pane: Canvas -->
    <section id="form-canvas">
        <h4>Form Canvas</h4>
    </section>



    <!-- Right Pane: Properties -->
    <section id="properties">

        <h4>Properties</h4>
        <form id="properties-form">
            <p>Click a field to edit</p>
        </form>
    </section>

    <!-- Templates for Properties -->
    <template id="tmpl-generic">
        <div class="prop-generic">
            <div>
                <input type="text" class="prop-label">
            </div>
            <div>
                <label>Required</label>
                <select class="prop-required">
                    <option value="false" selected>Not required</option>
                    <option value="true">Required</option>
                </select>
            </div>
        </div>
    </template>

    <!-- Unified input template -->
    <template id="tmpl-input">
        <div class="prop-input">
            <div>
                <label>Type</label>
                <select class="prop-input-type">
                    <optgroup label="Textual">
                        <option value="text">Text</option>
                        <option value="password">Password</option>
                        <option value="email">Email</option>
                        <option value="url">URL</option>
                        <option value="search">Search</option>
                        <option value="tel">Tel</option>
                    </optgroup>

                    <optgroup label="Numeric">
                        <option value="number">Number</option>
                        <option value="range">Range</option>
                    </optgroup>

                    <optgroup label="Date & Time">
                        <option value="date">Date</option>
                        <option value="datetime-local">Datetime</option>
                        <option value="month">Month</option>
                        <option value="time">Time</option>
                        <option value="week">Week</option>
                    </optgroup>

                    <optgroup label="Other">
                        <option value="file">File</option>
                    </optgroup>
                </select>

            </div>

            <div>
                <label>Default value</label>
                <input type="text" class="prop-default">
            </div>

            <div>
                <label>Placeholder</label>
                <input type="text" class="prop-placeholder">
            </div>

            <!-- Numeric / Slider + Date/Time -->
            <div class="extra-range">
                <!-- Number / Range -->
                <div class="range-numeric">
                    <label>Min</label>
                    <input type="number" class="prop-min">
                    <label>Max</label>
                    <input type="number" class="prop-max">
                    <label>Step (numeric unit)</label>
                    <input type="number" class="prop-step" step="any">
                </div>

                <!-- Date -->
                <div class="range-date">
                    <label>Min</label>
                    <input type="date" class="prop-min">
                    <label>Max</label>
                    <input type="date" class="prop-max">
                </div>

                <!-- Datetime -->
                <div class="range-datetime">
                    <label>Min</label>
                    <input type="datetime-local" class="prop-min">
                    <label>Max</label>
                    <input type="datetime-local" class="prop-max">
                </div>

                <!-- Month -->
                <div class="range-month">
                    <label>Min</label>
                    <input type="month" class="prop-min">
                    <label>Max</label>
                    <input type="month" class="prop-max">
                </div>

                <!-- Time -->
                <div class="range-time">
                    <label>Min</label>
                    <input type="time" class="prop-min" step="1">
                    <label>Max</label>
                    <input type="time" class="prop-max" step="1">
                </div>

                <!-- Week -->
                <div class="range-week">
                    <label>Min</label>
                    <input type="week" class="prop-min">
                    <label>Max</label>
                    <input type="week" class="prop-max">
                </div>
            </div>




            <!-- Textual -->
            <div class="extra-textual">
                <label>Minlength</label>
                <input type="number" class="prop-minlength" min="0">
                <label>Maxlength</label>
                <input type="number" class="prop-maxlength" min="1">
                <label>Size (chars)</label>
                <input type="number" class="prop-size" min="1">
                <label>Autocomplete</label>
                <select class="prop-autocomplete">
                    <option value="">Default</option>
                    <option value="on">On</option>
                    <option value="off">Off</option>
                </select>
                <label>Pattern (regex)</label>
                <input type="text" class="prop-pattern">
            </div>

            <!-- File-specific -->
            <div class="extra-file">
                <label>Accept</label>
                <input type="text" class="prop-accept" placeholder="e.g. image/*,.pdf">
                <label>Multiple</label>
                <select class="prop-multiple">
                    <option value="false">Single file</option>
                    <option value="true">Multiple files</option>
                </select>
            </div>
        </div>
    </template>

    <template id="tmpl-select">
        <div class="prop-select">
            <div>
                <label>Type</label>
                <select class="prop-multiple">
                    <option value="false" selected>Single choice</option>
                    <option value="true">Multiple choices</option>
                </select>
            </div>
            <div>
                <label>Default option</label>
                <select class="prop-default-option"></select>
            </div>
            <div>
                <label>Options (comma separated)</label>
                <input type="text" class="prop-options">
            </div>
            <div>
                <label>Size (rows)</label>
                <input type="number" class="prop-size" min="1">
            </div>
        </div>
    </template>

    <template id="tmpl-textarea">
        <div class="prop-textarea">
            <div>
                <label>Rows</label>
                <input type="number" class="prop-rows" min="1">
            </div>
            <div>
                <label>Minlength</label>
                <input type="number" class="prop-minlength" min="0">
            </div>
            <div>
                <label>Maxlength</label>
                <input type="number" class="prop-maxlength" min="1">
            </div>
            <div>
                <label>Placeholder</label>
                <input type="text" class="prop-placeholder">
            </div>
            <div>
                <label>Default value</label>
                <input type="text" class="prop-default">
            </div>
            <div>
                <label>Wrap</label>
                <select class="prop-wrap">
                    <option value="">Default</option>
                    <option value="soft">Soft</option>
                    <option value="hard">Hard</option>
                    <option value="off">Off</option>
                </select>
            </div>
        </div>
    </template>


    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script>
        const toolbox = document.getElementById('toolbox');
        const canvas = document.getElementById('form-canvas');
        const propertiesForm = document.getElementById('properties-form');
        let selectedField = null;

        function saveCanvas() {
            localStorage.setItem('dashmin-canvas', canvas.innerHTML);
        }

        function restoreCanvas() {
            const saved = localStorage.getItem('dashmin-canvas');
            if (saved) {
                canvas.innerHTML = saved;
            }
        }

        Sortable.create(toolbox, {
            group: { name: 'fields', pull: 'clone', put: false },
            sort: false,
            animation: 150
        });

        Sortable.create(canvas, {
            group: { name: 'fields', pull: false, put: true },
            animation: 150,
            onAdd(evt) {
                const field = evt.item.querySelector('.field');
                if (field) {
                    evt.item.replaceWith(field);
                    selectedField = field;
                    showProperties(field);
                    saveCanvas();
                }
            },
            onSort(evt) {
                saveCanvas();
            }
        });

        canvas.addEventListener('click', e => {
            const field = e.target.closest('.field');
            if (!field || !canvas.contains(field)) return;
            selectedField = field;
            showProperties(field);
        });

        function showProperties(field) {
            propertiesForm.innerHTML = '';
            const input = field.querySelector('input, select, textarea');
            const label = field.querySelector('label');
            if (!input) return;

            const base = document.getElementById('tmpl-generic').content.cloneNode(true);
            propertiesForm.appendChild(base);

            propertiesForm.querySelector('.prop-label').value = label?.innerText || '';
            propertiesForm.querySelector('.prop-label').oninput = e => { if (label) label.innerText = e.target.value; saveCanvas(); };

            const requiredEl = propertiesForm.querySelector('.prop-required');
            requiredEl.value = input.required ? 'true' : 'false';
            requiredEl.onchange = e => {
                input.required = (e.target.value === 'true');
                saveCanvas();
            };

            if (input.tagName === 'INPUT') {
                handleInputProperties(input, field);
            } else if (input.tagName === 'SELECT') {
                handleSelectProperties(input);
            } else if (input.tagName === 'TEXTAREA') {
                handleTextareaProperties(input);
            }

        }

        function handleInputProperties(input, field) {
            const inputProps = document.getElementById('tmpl-input').content.cloneNode(true);
            propertiesForm.appendChild(inputProps);

            const typeSelect = propertiesForm.querySelector('.prop-input-type');
            typeSelect.value = input.type || 'text';
            typeSelect.onchange = e => {
                input.type = e.target.value;
                saveCanvas();
                showProperties(field);
            };

            const defaultEl = propertiesForm.querySelector('.prop-default');
            defaultEl.value = input.dataset.default || '';
            defaultEl.oninput = e => { input.dataset.default = e.target.value; saveCanvas(); };

            const placeholderEl = propertiesForm.querySelector('.prop-placeholder');
            placeholderEl.value = input.placeholder || '';
            placeholderEl.oninput = e => { input.placeholder = e.target.value; saveCanvas(); };

            function toggleExtras() {
                const type = input.type;
                propertiesForm.querySelectorAll('.extra-range > div').forEach(div => {
                    div.style.display = 'none';
                });
                if (['number', 'range'].includes(type)) {
                    propertiesForm.querySelector('.range-numeric').style.display = 'block';
                } else if (type === 'date') {
                    propertiesForm.querySelector('.range-date').style.display = 'block';
                } else if (type === 'datetime-local') {
                    propertiesForm.querySelector('.range-datetime').style.display = 'block';
                } else if (type === 'month') {
                    propertiesForm.querySelector('.range-month').style.display = 'block';
                } else if (type === 'time') {
                    propertiesForm.querySelector('.range-time').style.display = 'block';
                } else if (type === 'week') {
                    propertiesForm.querySelector('.range-week').style.display = 'block';
                }

                const showTextual = ['text', 'password', 'email', 'search', 'tel', 'url'].includes(type);
                const showFile = (type === 'file');
                propertiesForm.querySelector('.extra-textual').style.display = showTextual ? 'block' : 'none';
                propertiesForm.querySelector('.extra-file').style.display = showFile ? 'block' : 'none';
            }
            toggleExtras();

            // Range, Textual, File extras as in your original code…
            // (keep min/max/step, minlength/maxlength/size, accept/multiple bindings)
        }

        function handleSelectProperties(input) {
            const selectProps = document.getElementById('tmpl-select').content.cloneNode(true);
            propertiesForm.appendChild(selectProps);

            const optionsEl = propertiesForm.querySelector('.prop-options');
            optionsEl.value = Array.from(input.options).map(o => o.text).join(', ');
            optionsEl.oninput = e => {
                const values = e.target.value.split(',').map(s => s.trim()).filter(Boolean);
                input.innerHTML = '';
                values.forEach(v => {
                    const opt = document.createElement('option');
                    opt.text = v;
                    opt.value = v;
                    input.add(opt);
                });
                refreshDefaultOptions();
                saveCanvas();
            };

            const multipleEl = propertiesForm.querySelector('.prop-multiple');
            multipleEl.value = input.multiple ? 'true' : 'false';
            multipleEl.onchange = e => { input.multiple = (e.target.value === 'true'); saveCanvas(); };

            const sizeEl = propertiesForm.querySelector('.prop-size');
            sizeEl.value = input.size || 1;
            sizeEl.oninput = e => { input.size = e.target.value; saveCanvas(); };

            const defaultEl = propertiesForm.querySelector('.prop-default-option');
            function refreshDefaultOptions() {
                defaultEl.innerHTML = '';
                Array.from(input.options).forEach((opt, idx) => {
                    const o = document.createElement('option');
                    o.value = idx;
                    o.text = opt.text;
                    if (opt.selected) o.selected = true;
                    defaultEl.add(o);
                });
            }
            refreshDefaultOptions();
            defaultEl.onchange = e => {
                const idx = parseInt(e.target.value, 10);
                Array.from(input.options).forEach((opt, i) => opt.selected = (i === idx));
                saveCanvas();
            };
        }

        function handleTextareaProperties(input) {
            const taProps = document.getElementById('tmpl-textarea').content.cloneNode(true);
            propertiesForm.appendChild(taProps);

            const rowsEl = propertiesForm.querySelector('.prop-rows');
            const minEl = propertiesForm.querySelector('.prop-minlength');
            const maxEl = propertiesForm.querySelector('.prop-maxlength');
            const wrapEl = propertiesForm.querySelector('.prop-wrap');
            const placeholderEl = propertiesForm.querySelector('.prop-placeholder');
            const defaultEl = propertiesForm.querySelector('.prop-default');

            rowsEl.value = input.rows || '';
            minEl.value = input.minLength > 0 ? input.minLength : '';
            maxEl.value = input.maxLength > 0 ? input.maxLength : '';
            wrapEl.value = input.wrap || '';
            placeholderEl.value = input.placeholder || '';
            defaultEl.value = input.dataset.default || '';

            rowsEl.oninput = e => { input.rows = e.target.value; saveCanvas(); };
            minEl.oninput = e => { input.minLength = e.target.value; saveCanvas(); };
            maxEl.oninput = e => { input.maxLength = e.target.value; saveCanvas(); };
            wrapEl.onchange = e => { input.wrap = e.target.value; saveCanvas(); };
            placeholderEl.oninput = e => { input.placeholder = e.target.value; saveCanvas(); };
            defaultEl.oninput = e => { input.dataset.default = e.target.value; saveCanvas(); };
        }

        document.getElementById('generate-sql').addEventListener('click', generateSQL);

        function generateSQL() {
            const fields = canvas.querySelectorAll('.field');
            let cols = [];

            fields.forEach((field, idx) => {
                const input = field.querySelector('input, select, textarea');
                const label = field.querySelector('label');
                if (!input) return;

                // derive field name from label or fallback
                let rawName = (label?.innerText || input.name || `col_${idx + 1}`).trim();
                let name = slugify(rawName) || `col_${idx + 1}`;
                let col = `\`${name}\``;

                // Map input types to SQL
                if (input.tagName === 'TEXTAREA') {
                    col += ' TEXT';
                    if (input.maxLength > 0) col += `(${input.maxLength})`;
                } else if (input.tagName === 'SELECT') {
                    const opts = Array.from(input.options).map(o => `'${o.value}'`);
                    col += opts.length ? ` ENUM(${opts.join(',')})` : ' VARCHAR(255)';
                } else if (input.tagName === 'INPUT') {
                    switch (input.type) {
                        case 'number':
                        case 'range':
                            col += ' INT';
                            break;
                        case 'date':
                            col += ' DATE';
                            break;
                        case 'datetime-local':
                            col += ' DATETIME';
                            break;
                        case 'time':
                            col += ' TIME';
                            break;
                        case 'month':
                            col += ' YEAR(2)';
                            break;
                        case 'week':
                            col += ' VARCHAR(10)';
                            break;
                        case 'file':
                            col += ' VARCHAR(255)';
                            break;
                        default:
                            let len = input.maxLength > 0 ? input.maxLength : 255;
                            col += ` VARCHAR(${len})`;
                    }
                }

                if (input.required) col += ' NOT NULL';
                if (input.dataset.default) col += ` DEFAULT '${input.dataset.default}'`;

                cols.push(col);
            });

            const sql = `CREATE TABLE my_table (\n  id INT AUTO_INCREMENT PRIMARY KEY,\n  ${cols.join(',\n  ')}\n);`;

            document.getElementById('sql-output').textContent = sql;
        }

        function slugify(str) {
            return str
                .toLowerCase()
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // remove accents
                .replace(/[^a-z0-9]+/g, "_") // non-alphanumerics → _
                .replace(/^_+|_+$/g, ""); // trim leading/trailing _
        }

        window.addEventListener('DOMContentLoaded', restoreCanvas);
    </script>
</body>

</html>